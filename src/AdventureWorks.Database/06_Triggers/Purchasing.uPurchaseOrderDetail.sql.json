{
  "triggerName": "uPurchaseOrderDetail",
  "schemaName": "Purchasing",
  "definition": "\r\nCREATE TRIGGER [Purchasing].[uPurchaseOrderDetail] ON [Purchasing].[PurchaseOrderDetail] \r\nAFTER UPDATE AS \r\nBEGIN\r\n    DECLARE @Count int;\r\n\r\n    SET @Count = @@ROWCOUNT;\r\n    IF @Count = 0 \r\n        RETURN;\r\n\r\n    SET NOCOUNT ON;\r\n\r\n    BEGIN TRY\r\n        IF UPDATE([ProductID]) OR UPDATE([OrderQty]) OR UPDATE([UnitPrice])\r\n        -- Insert record into TransactionHistory \r\n        BEGIN\r\n            INSERT INTO [Production].[TransactionHistory]\r\n                ([ProductID]\r\n                ,[ReferenceOrderID]\r\n                ,[ReferenceOrderLineID]\r\n                ,[TransactionType]\r\n                ,[TransactionDate]\r\n                ,[Quantity]\r\n                ,[ActualCost])\r\n            SELECT \r\n                inserted.[ProductID]\r\n                ,inserted.[PurchaseOrderID]\r\n                ,inserted.[PurchaseOrderDetailID]\r\n                ,'P'\r\n                ,GETDATE()\r\n                ,inserted.[OrderQty]\r\n                ,inserted.[UnitPrice]\r\n            FROM inserted \r\n                INNER JOIN [Purchasing].[PurchaseOrderDetail] \r\n                ON inserted.[PurchaseOrderID] = [Purchasing].[PurchaseOrderDetail].[PurchaseOrderID];\r\n\r\n            -- Update SubTotal in PurchaseOrderHeader record. Note that this causes the \r\n            -- PurchaseOrderHeader trigger to fire which will update the RevisionNumber.\r\n            UPDATE [Purchasing].[PurchaseOrderHeader]\r\n            SET [Purchasing].[PurchaseOrderHeader].[SubTotal] = \r\n                (SELECT SUM([Purchasing].[PurchaseOrderDetail].[LineTotal])\r\n                    FROM [Purchasing].[PurchaseOrderDetail]\r\n                    WHERE [Purchasing].[PurchaseOrderHeader].[PurchaseOrderID] \r\n                        = [Purchasing].[PurchaseOrderDetail].[PurchaseOrderID])\r\n            WHERE [Purchasing].[PurchaseOrderHeader].[PurchaseOrderID] \r\n                IN (SELECT inserted.[PurchaseOrderID] FROM inserted);\r\n\r\n            UPDATE [Purchasing].[PurchaseOrderDetail]\r\n            SET [Purchasing].[PurchaseOrderDetail].[ModifiedDate] = GETDATE()\r\n            FROM inserted\r\n            WHERE inserted.[PurchaseOrderID] = [Purchasing].[PurchaseOrderDetail].[PurchaseOrderID]\r\n                AND inserted.[PurchaseOrderDetailID] = [Purchasing].[PurchaseOrderDetail].[PurchaseOrderDetailID];\r\n        END;\r\n    END TRY\r\n    BEGIN CATCH\r\n        EXECUTE [dbo].[uspPrintError];\r\n\r\n        -- Rollback any active or uncommittable transactions before\r\n        -- inserting information in the ErrorLog\r\n        IF @@TRANCOUNT > 0\r\n        BEGIN\r\n            ROLLBACK TRANSACTION;\r\n        END\r\n\r\n        EXECUTE [dbo].[uspLogError];\r\n    END CATCH;\r\nEND;\r\n",
  "tableName": "PurchaseOrderDetail"
}